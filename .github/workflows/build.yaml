name: build test

on:
  workflow_dispatch:
  pull_request:

jobs:
  job:
    name: build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container: ros:${{ matrix.rosdistro }}
    env:
      DEBIAN_FRONTEND: noninteractive
    strategy:
      fail-fast: false
      matrix:
        rosdistro: [rolling]
        rosidl_branch: [feature/rosidl_auto_generate_interfaces]
    steps:
      - name: suppress warnings
        run: |
          git config --global --add safe.directory '*'

      - uses: actions/checkout@v4

      - uses: actions/checkout@v4
        with:
          repository: HansRobo/rosidl
          path: rosidl
          ref: ${{ matrix.rosidl_branch }}

      - name: Run rosdep install
        run: |
          sudo apt-get -yqq update
          rosdep update
          rosdep install -yqq --from-paths . --ignore-src --rosdistro ${{ matrix.rosdistro }}
        shell: bash

      - name: Set up colcon-mixin
        run: |
          colcon mixin add default https://raw.githubusercontent.com/colcon/colcon-mixin-repository/master/index.yaml || true
          colcon mixin update default
        shell: bash

      - name: Build
        run: |
          . /opt/ros/${{ matrix.rosdistro }}/setup.sh
          colcon build --event-handlers console_direct+
        shell: bash

      - name: Verify sample_interfaces generated files
        run: |
          echo "Checking generated header files..."
          ls -lh build/sample_interfaces/rosidl_generator_cpp/sample_interfaces/msg/
          echo ""
          echo "Expected files: test.hpp, test_a.hpp, test_b.hpp"
          test -f build/sample_interfaces/rosidl_generator_cpp/sample_interfaces/msg/test.hpp
          test -f build/sample_interfaces/rosidl_generator_cpp/sample_interfaces/msg/test_a.hpp
          test -f build/sample_interfaces/rosidl_generator_cpp/sample_interfaces/msg/test_b.hpp
          echo "✓ All header files generated successfully"
        shell: bash

      - name: Verify sample_interfaces executables
        run: |
          echo "Checking built executables..."
          ls -lh install/sample_interfaces/lib/sample_interfaces/
          echo ""
          echo "Verifying executables exist..."
          test -f install/sample_interfaces/lib/sample_interfaces/sample_interfaces_node
          test -f install/sample_interfaces/lib/sample_interfaces/sample_interfaces_node2
          test -f install/sample_interfaces/lib/sample_interfaces/sample_interfaces_node_no_targets
          echo "✓ All executables built successfully"
        shell: bash
